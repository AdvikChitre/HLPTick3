import { stepAndReadAllViewers, readAllViewers, step, disconnect, simpleConnect, connectAndRead, continuedOp, pauseOp } from "../UartFiles/IS-uart.js";
import { Optic_Get, Optic_Get_op_HatDot_Z146BA564, Optic_Set, Optic_Set_op_HatEquals_Z147477F8, Optic_Map, Optic_Map_op_HatPercent_Z1462312A } from "../Common/Optics.fs.js";
import { SheetT_PopupDialogData, SheetT_CompilationStageLabel, SheetT_DebugState, SheetT_CompileStatus, SheetT_CompilationStage, SheetT_CursorType, SymbolT_Model, BusWireT_WireType, SheetT_KeyboardMsg, SheetT_XYPosMov, SymbolT_Annotation, SheetT_CurrentAction, BusWireT_Model, SymbolT_Msg, BusWireT_Msg, SheetT_Model, SheetT_Msg, SheetT_symbol_, SheetT_boundingBoxes_, SheetT_symbols_ } from "../Model/DrawModelType.fs.js";
import { empty as empty_1, find, FSharpMap__Add, change, toList as toList_1, FSharpMap__get_Item, containsKey as containsKey_1, fold, map } from "../fable_modules/fable-library.4.1.4/Map.js";
import { getBoundingBoxes, calcLabelBoundingBox } from "./Symbol.fs.js";
import { printStats, getTimeMs } from "../Common/TimeHelpers.fs.js";
import { Constants_defaultCanvasSize, notIntersectingComponents, viewIsAfterUpdateScroll, recentProgrammaticScrollPos, canvasDiv, scrollSequence, getScreenEdgeCoords, Constants_zoomIncrement, Constants_maxMagnification, symbolCmd, wireCmd, sheetCmd, ensureCanvasExtendsBeyondScreen } from "./Sheet.fs.js";
import { curry2, safeHash, comparePrimitives, compare, equals } from "../fable_modules/fable-library.4.1.4/Util.js";
import { flipBlock, rotateBlock, postUpdateScalingBox } from "./RotateScale.fs.js";
import { Cmd_ofSub, Cmd_map, Cmd_none, Cmd_batch } from "../fable_modules/Fable.Elmish.3.1.0/cmd.fs.js";
import { removeAt, insertAt, reverse, contains, append, filter, item, exists, max as max_1, map as map_1, cons, length, truncate, tail, head, isEmpty, ofArray, empty, singleton } from "../fable_modules/fable-library.4.1.4/List.js";
import { init as init_1, newWire, pasteWires, update as update_1 } from "./BusWireUpdate.fs.js";
import { getConnectedWireIds } from "./BusWireUpdateHelpers.fs.js";
import { ofList, union, toList } from "../fable_modules/fable-library.4.1.4/Set.js";
import { hextoInt, rotateSelectedLabelsClockwise, arrangeSymbols, mDownUpdate, mMoveUpdate, mUpUpdate, mDragUpdate, getVisibleScreenCentre, fitCircuitToScreenUpdate, appendUndoList } from "./SheetUpdateHelpers.fs.js";
import { addSymbol, pasteSymbols } from "./SymbolUpdate.fs.js";
import { $007CIsGate$007CNoGate$007C, ComponentType, BoundingBox, XYPos, HighLightColor } from "../Common/CommonTypes.fs.js";
import { emptySnap } from "./SheetSnap.fs.js";
import { min, max } from "../fable_modules/fable-library.4.1.4/Double.js";
import { some, value as value_10, defaultArg, map as map_2 } from "../fable_modules/fable-library.4.1.4/Option.js";
import { getActivePressedKeys, writeCanvasScroll } from "./SheetDisplay.fs.js";
import { join, toFail, printf, toConsole } from "../fable_modules/fable-library.4.1.4/String.js";
import { MouseT, MouseOp } from "../Common/DrawHelpers.fs.js";
import { Model, Msg } from "../Model/ModelType.fs.js";
import * as react from "react";
import { debugLevel } from "../Interface/JSHelpers.fs.js";
import * as child_process from "child_process";
import { sleep, startImmediate } from "../fable_modules/fable-library.4.1.4/Async.js";
import { singleton as singleton_1 } from "../fable_modules/fable-library.4.1.4/AsyncBuilder.js";
import { toString, FSharpRef } from "../fable_modules/fable-library.4.1.4/Types.js";
import { CompilationProfile } from "../Simulator/Verilog.fs.js";
import { iterateIndexed } from "../fable_modules/fable-library.4.1.4/Array.js";
import { toList as toList_2 } from "../fable_modules/fable-library.4.1.4/Seq.js";
import { rangeDouble } from "../fable_modules/fable-library.4.1.4/Range.js";
import { Cmd_OfFunc_result } from "../fable_modules/Fable.Elmish.3.1.0/./cmd.fs.js";


export function updateBoundingBoxes(model) {
    let value;
    return Optic_Map_op_HatPercent_Z1462312A(new Optic_Map(), SheetT_symbols_)((table) => map((_arg, sym) => calcLabelBoundingBox(sym), table))(((value = getBoundingBoxes(model.Wire.Symbol), Optic_Set_op_HatEquals_Z147477F8(new Optic_Set(), SheetT_boundingBoxes_)(value)))(model));
}

/**
 * Update Function
 */
export function update(msg, issieModel) {
    let wMsg, patternInput, wModel, wCmd, wiresConnectedToComponents, wireUnion, patternInput_1, pastedCompIds, newSymbolModel, patternInput_2, inputRecord, pastedConnIds, newBusWireModel, matchValue_1, prevModel, lst, appendRedoList, matchValue_3, newModel, lst_1, symbols, wires, oldScreenCentre, edge, newZoom, minXZoom, minYZoom, oldScreenCentre_1, mMsg, mouseAlreadyDown, matchValue_6, matchValue_7, compId, symb, sym_1, patternInput_3, sym_2, comp, matchValue_9, vS, hS, matchValue_2_1, w, h, left, right, dispatch, pos, sequence, model_5, matchValue_10, matchValue_11, el, scrollPos, scrollDif, left_2, right_2, pos_1, scaleFactor, newLastScrollingPos, left_3, right_3, cmd_2, ldcs, port, pos_2, rotation, patternInput_5, newSymModel, ncID, ncPortId, patternInput_6, inputRecord_1, newWireModel, msgOpt, wCmd_1, oldScreenCentre_2, canvas, newScreenCentre, requiredOffset, left_4, right_4, key, containsKey, newPressedKeys, newCmd, key_2, removeAllKeys, canvas_1, wholeApp, rightSelection, leftScreenEdge, rightScreenEdge, upperScreenEdge, lowerScreenEdge, mPosX, mPosY, mMovX, mMovY, checkForAutomaticScrolling1D, xDiff, yDiff, newMPos, zero, defaultMsg, patternInput_7, matchValue_14, outputModel, outputCmd, notAutomaticScrolling, filteredOutputCmd, outputModel_1, arrange, rotation_1, rotmodel, inputRecord_2, newModel_1, errorComponents, orientation, flipmodel, inputRecord_3, newModel_2, errorComponents_1, nextAction, wires_2, wires_3, wires_1, compType, lbl, ldcs_1, UndoList_5, inputRecord_4, inputRecord_5, children, connIds, on, oldWires, newWires, colour, compIds, connIds_1, cIds, newWires_1, isOn, name, path, profile, name_1, path_1, profile_1, stage, arg_7, cwd, include_path, patternInput_8, matchValue_16, pcf, deviceType, devicePackage, patternInput_9, prog, args, options, o, child, startComp, matchValue_18, child_1, failIfInProgress, pid, correctPid, tick, model_6, finishOrStart, synthesis, placeAndRoute, generate, upload, isCompiling, remainder, viewerNo, n_2, readSingleStep, n_3, readSingleStep_1, remainder_1, viewerNo_1, connectAndRead, data, whichViewer, part, bits, mappings, remainder_2, viewerNo_2, device, sheetMsgs, wModel_1;
    const model = issieModel.Sheet;
    const postUpdateChecks = (tupledArg) => {
        const model_1 = tupledArg[0];
        const cmd = tupledArg[1];
        const start = getTimeMs();
        const sModel = Optic_Get_op_HatDot_Z146BA564(new Optic_Get(), SheetT_symbol_)(model_1);
        const inputModel = ensureCanvasExtendsBeyondScreen(fold((model_2, sId, sym) => {
            let value;
            if (containsKey_1(sId, model_2.BoundingBoxes) && equals(sym.Pos, FSharpMap__get_Item(model_2.BoundingBoxes, sId).TopLeft)) {
                return model_2;
            }
            else {
                return ((value = getBoundingBoxes(sModel), Optic_Set_op_HatEquals_Z147477F8(new Optic_Set(), SheetT_boundingBoxes_)(value)))(model_2);
            }
        }, model_1, sModel.Symbols));
        const tupledArg_1 = [inputModel, cmd];
        return postUpdateScalingBox(tupledArg_1[0], tupledArg_1[1]);
    };
    const tupledArg_4 = postUpdateChecks((msg.tag === 0) ? ((msg.fields[0].tag === 0) ? ((msg.fields[0].fields[0].tag === 42) ? [model, Cmd_batch(singleton(sheetCmd(new SheetT_Msg(6, []))))] : ((wMsg = msg.fields[0], (patternInput = update_1(wMsg, issieModel), (wModel = patternInput[0], (wCmd = patternInput[1], [new SheetT_Model(wModel.Sheet.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), wCmd])))))) : ((wMsg = msg.fields[0], (patternInput = update_1(wMsg, issieModel), (wModel = patternInput[0], (wCmd = patternInput[1], [new SheetT_Model(wModel.Sheet.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), wCmd])))))) : ((msg.tag === 3) ? [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, !model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()] : ((msg.tag === 2) ? ((msg.fields[0].tag === 13) ? ((wiresConnectedToComponents = getConnectedWireIds(model.Wire, model.SelectedComponents), (wireUnion = toList(union(ofList(wiresConnectedToComponents, {
        Compare: compare,
    }), ofList(model.SelectedWires, {
        Compare: compare,
    }))), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, empty(), empty(), model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, appendUndoList(model.UndoList, model), empty(), model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([wireCmd(new BusWireT_Msg(4, [wireUnion])), symbolCmd(new SymbolT_Msg(3, [model.SelectedComponents])), sheetCmd(new SheetT_Msg(6, []))]))]))) : ((msg.fields[0].tag === 0) ? [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, getBoundingBoxes(model.Wire.Symbol), model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, appendUndoList(model.UndoList, model), empty(), model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([sheetCmd(new SheetT_Msg(6, [])), symbolCmd(new SymbolT_Msg(40, []))]))] : ((msg.fields[0].tag === 10) ? ((printStats(), [model, Cmd_none()])) : ((msg.fields[0].tag === 1) ? [model, Cmd_batch(ofArray([symbolCmd(new SymbolT_Msg(2, [model.SelectedComponents])), wireCmd(new BusWireT_Msg(3, [model.SelectedWires]))]))] : ((msg.fields[0].tag === 2) ? ((patternInput_1 = pasteSymbols(model.Wire.Symbol, model.Wire.Wires, model.LastMousePos), (pastedCompIds = patternInput_1[1], (newSymbolModel = patternInput_1[0], (patternInput_2 = pasteWires((inputRecord = model.Wire, new BusWireT_Model(newSymbolModel, inputRecord.Wires, inputRecord.CopiedWires, inputRecord.SelectedSegment, inputRecord.LastMousePos, inputRecord.ErrorWires, inputRecord.Notifications, inputRecord.Type, inputRecord.ArrowDisplay, inputRecord.SnapToNet)), pastedCompIds), (pastedConnIds = patternInput_2[1], (newBusWireModel = patternInput_2[0], [new SheetT_Model(newBusWireModel, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, pastedCompIds, pastedConnIds, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, new SheetT_CurrentAction(5, []), model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([sheetCmd(new SheetT_Msg(6, [])), symbolCmd(new SymbolT_Msg(11, [empty()])), symbolCmd(new SymbolT_Msg(14, [pastedCompIds])), wireCmd(new BusWireT_Msg(6, [empty()])), wireCmd(new BusWireT_Msg(11, [pastedConnIds, new HighLightColor(9, [])]))]))]))))))) : ((msg.fields[0].tag === 14) ? ((model.Action.tag === 5) ? [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, empty(), empty(), model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, new SheetT_CurrentAction(11, []), model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, emptySnap, emptySnap, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([symbolCmd(new SymbolT_Msg(3, [model.SelectedComponents])), wireCmd(new BusWireT_Msg(4, [model.SelectedWires])), sheetCmd(new SheetT_Msg(6, []))]))] : [model, Cmd_none()]) : ((msg.fields[0].tag === 3) ? ((matchValue_1 = model.UndoList, !isEmpty(matchValue_1) ? ((prevModel = head(matchValue_1), (lst = tail(matchValue_1), (appendRedoList = ((redoList, model_in) => {
        let n;
        const removeLast = (inputLst) => truncate(max(0, length(inputLst) - 1), inputLst);
        const matchValue_2 = length(redoList) | 0;
        if ((n = (matchValue_2 | 0), n < 500)) {
            const n_1 = matchValue_2 | 0;
            return cons(model_in, redoList);
        }
        else {
            return cons(model_in, removeLast(redoList));
        }
    }), [new SheetT_Model(prevModel.Wire, prevModel.PopupViewFunc, prevModel.PopupDialogData, prevModel.BoundingBoxes, prevModel.LastValidBoundingBoxes, prevModel.SelectedLabel, prevModel.SelectedComponents, prevModel.SelectedWires, prevModel.NearbyComponents, prevModel.ErrorComponents, prevModel.DragToSelectBox, prevModel.ConnectPortsLine, prevModel.TargetPortId, prevModel.Action, prevModel.ShowGrid, prevModel.CursorType, prevModel.LastValidPos, prevModel.LastValidSymbol, prevModel.SnapSymbols, prevModel.SnapSegments, empty(), prevModel.Zoom, prevModel.CanvasSize, prevModel.TmpModel, prevModel.ScalingTmpModel, lst, appendRedoList(model.RedoList, model), prevModel.AutomaticScrolling, prevModel.ScreenScrollPos, prevModel.LastMousePos, prevModel.ScalingBoxCentrePos, prevModel.InitMouseToScalingBoxCentre, prevModel.ScrollingLastMousePos, prevModel.LastMousePosForSnap, prevModel.MouseCounter, prevModel.CtrlKeyDown, prevModel.PrevWireSelection, prevModel.ScalingBox, prevModel.Compiling, prevModel.CompilationStatus, prevModel.CompilationProcess, prevModel.DebugState, prevModel.DebugData, prevModel.DebugMappings, prevModel.DebugIsConnected, prevModel.DebugDevice), Cmd_batch(singleton(sheetCmd(new SheetT_Msg(14, []))))])))) : [model, Cmd_none()])) : ((msg.fields[0].tag === 4) ? ((matchValue_3 = model.RedoList, !isEmpty(matchValue_3) ? ((newModel = head(matchValue_3), (lst_1 = tail(matchValue_3), [new SheetT_Model(newModel.Wire, newModel.PopupViewFunc, newModel.PopupDialogData, newModel.BoundingBoxes, newModel.LastValidBoundingBoxes, newModel.SelectedLabel, newModel.SelectedComponents, newModel.SelectedWires, newModel.NearbyComponents, newModel.ErrorComponents, newModel.DragToSelectBox, newModel.ConnectPortsLine, newModel.TargetPortId, newModel.Action, newModel.ShowGrid, newModel.CursorType, newModel.LastValidPos, newModel.LastValidSymbol, newModel.SnapSymbols, newModel.SnapSegments, empty(), newModel.Zoom, newModel.CanvasSize, newModel.TmpModel, newModel.ScalingTmpModel, cons(model, model.UndoList), lst_1, newModel.AutomaticScrolling, newModel.ScreenScrollPos, newModel.LastMousePos, newModel.ScalingBoxCentrePos, newModel.InitMouseToScalingBoxCentre, newModel.ScrollingLastMousePos, newModel.LastMousePosForSnap, newModel.MouseCounter, newModel.CtrlKeyDown, newModel.PrevWireSelection, newModel.ScalingBox, newModel.Compiling, newModel.CompilationStatus, newModel.CompilationProcess, newModel.DebugState, newModel.DebugData, newModel.DebugMappings, newModel.DebugIsConnected, newModel.DebugDevice), Cmd_batch(singleton(sheetCmd(new SheetT_Msg(14, []))))]))) : [model, Cmd_none()])) : ((msg.fields[0].tag === 5) ? ((symbols = map_1((tuple) => tuple[0], toList_1(model.Wire.Symbol.Symbols)), (wires = map_1((tuple_1) => tuple_1[0], toList_1(model.Wire.Wires)), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, symbols, wires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([symbolCmd(new SymbolT_Msg(11, [symbols])), wireCmd(new BusWireT_Msg(6, [wires]))]))]))) : ((msg.fields[0].tag === 6) ? fitCircuitToScreenUpdate(model) : ((msg.fields[0].tag === 11) ? ((oldScreenCentre = getVisibleScreenCentre(model), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, min(Constants_maxMagnification, model.Zoom * Constants_zoomIncrement), model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), sheetCmd(new SheetT_Msg(4, [oldScreenCentre]))])) : ((msg.fields[0].tag === 12) ? ((edge = getScreenEdgeCoords(model), (newZoom = ((minXZoom = ((edge.Right - edge.Left) / model.CanvasSize), (minYZoom = ((edge.Top - edge.Bottom) / model.CanvasSize), max_1(ofArray([model.Zoom / Constants_zoomIncrement, minXZoom, minYZoom]), {
        Compare: comparePrimitives,
    })))), (oldScreenCentre_1 = getVisibleScreenCentre(model), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, newZoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), sheetCmd(new SheetT_Msg(4, [oldScreenCentre_1]))])))) : [model, Cmd_none()])))))))))))) : ((msg.tag === 24) ? ((model.Action.tag === 11) ? [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, true, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([symbolCmd(new SymbolT_Msg(10, [model.NearbyComponents])), symbolCmd(new SymbolT_Msg(36, [model.NearbyComponents]))]))] : [model, Cmd_none()]) : ((msg.tag === 25) ? ((model.Action.tag === 11) ? [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, false, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([symbolCmd(new SymbolT_Msg(9, [model.NearbyComponents])), symbolCmd(new SymbolT_Msg(37, [model.NearbyComponents]))]))] : [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, false, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()]) : ((msg.tag === 5) ? ((mMsg = msg.fields[0], (mouseAlreadyDown = ((matchValue_6 = model.Action, (matchValue_6.tag === 14) ? true : ((matchValue_6.tag === 8) ? true : (matchValue_6.tag === 9)))), (matchValue_7 = mMsg.Op, (matchValue_7.tag === 3) ? mDragUpdate(model, mMsg) : ((matchValue_7.tag === 0) ? mUpUpdate(model, mMsg) : ((matchValue_7.tag === 2) ? mMoveUpdate(model, mMsg) : ((mouseAlreadyDown === true) ? [model, Cmd_none()] : mDownUpdate(model, mMsg)))))))) : ((msg.tag === 6) ? [updateBoundingBoxes(model), Cmd_none()] : ((msg.tag === 7) ? ((compId = msg.fields[0], containsKey_1(compId, model.BoundingBoxes) ? [Optic_Map_op_HatPercent_Z1462312A(new Optic_Map(), SheetT_symbols_)((table_3) => change(compId, (option) => map_2(calcLabelBoundingBox, option), table_3))(new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, FSharpMap__Add(model.BoundingBoxes, compId, (symb = find(compId, model.Wire.Symbol.Symbols), (sym_1 = symb, (patternInput_3 = ((sym_2 = sym_1, (comp = sym_2.Component, (matchValue_9 = defaultArg(sym_2.HScale, 1), (vS = defaultArg(sym_2.VScale, 1), (hS = matchValue_9, (matchValue_2_1 = sym_2.STransform.Rotation, (matchValue_2_1.tag === 2) ? [comp.H * vS, comp.W * hS] : ((matchValue_2_1.tag === 1) ? [comp.W * hS, comp.H * vS] : ((matchValue_2_1.tag === 3) ? [comp.W * hS, comp.H * vS] : [comp.H * vS, comp.W * hS]))))))))), (w = patternInput_3[1], (h = patternInput_3[0], equals(sym_1.Annotation, new SymbolT_Annotation(0, [])) ? (new BoundingBox((left = sym_1.Pos, (right = (new XYPos(9, 9)), new XYPos(left.X - right.X, left.Y - right.Y))), 17, 17)) : (new BoundingBox(sym_1.Pos, w, h)))))))), model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice)), Cmd_none()] : [model, Cmd_none()])) : ((msg.tag === 9) ? ((dispatch = msg.fields[2], (pos = msg.fields[1], (sequence = (msg.fields[0] | 0), (model_5 = ((matchValue_10 = ((sequence - scrollSequence()) >= 0), (matchValue_11 = canvasDiv(), (matchValue_11 != null) ? (matchValue_10 ? ((el = matchValue_11, exists((recent) => {
        let vec, left_1, right_1;
        return ((vec = ((left_1 = recent, (right_1 = pos, new XYPos(left_1.X - right_1.X, left_1.Y - right_1.Y)))), Math.sqrt(Math.pow(vec.X, 2) + Math.pow(vec.Y, 2)))) < 0.001;
    }, recentProgrammaticScrollPos()) ? model : (new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, pos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice)))) : model) : model))), [model_5, Cmd_none()]))))) : ((msg.tag === 8) ? ((scrollPos = msg.fields[0], (scrollDif = ((left_2 = scrollPos, (right_2 = ((pos_1 = model.ScreenScrollPos, (scaleFactor = (1 / model.Zoom), new XYPos(pos_1.X * scaleFactor, pos_1.Y * scaleFactor)))), new XYPos(left_2.X - right_2.X, left_2.Y - right_2.Y)))), (newLastScrollingPos = (new SheetT_XYPosMov((left_3 = model.ScrollingLastMousePos.Pos, (right_3 = scrollDif, new XYPos(left_3.X + right_3.X, left_3.Y + right_3.Y))), model.ScrollingLastMousePos.Move)), (cmd_2 = (model.AutomaticScrolling ? sheetCmd(new SheetT_Msg(13, [])) : Cmd_none()), (recentProgrammaticScrollPos(cons(scrollPos, truncate(4, recentProgrammaticScrollPos()))), (scrollSequence(scrollSequence() + 1), (viewIsAfterUpdateScroll(true), (writeCanvasScroll(scrollPos), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, scrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, newLastScrollingPos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), cmd_2]))))))))) : ((msg.tag === 10) ? ((ldcs = msg.fields[0], (port = msg.fields[1], (pos_2 = msg.fields[2], (rotation = msg.fields[3], (patternInput_5 = addSymbol(ldcs, model.Wire.Symbol, pos_2, new ComponentType(4, []), ""), (newSymModel = patternInput_5[0], (ncID = patternInput_5[1], (ncPortId = item(0, FSharpMap__get_Item(newSymModel.Symbols, ncID).Component.InputPorts).Id, (patternInput_6 = newWire(ncPortId, port.Id, (inputRecord_1 = model.Wire, new BusWireT_Model(newSymModel, inputRecord_1.Wires, inputRecord_1.CopiedWires, inputRecord_1.SelectedSegment, inputRecord_1.LastMousePos, inputRecord_1.ErrorWires, inputRecord_1.Notifications, inputRecord_1.Type, inputRecord_1.ArrowDisplay, inputRecord_1.SnapToNet))), (newWireModel = patternInput_6[0], (msgOpt = patternInput_6[1], (wCmd_1 = ((msgOpt != null) ? wireCmd(value_10(msgOpt)) : Cmd_none()), [new SheetT_Model(newWireModel, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([wCmd_1, symbolCmd(new SymbolT_Msg(32, [singleton(ncID), rotation])), wireCmd(new BusWireT_Msg(19, [singleton(ncID)])), sheetCmd(new SheetT_Msg(6, []))]))]))))))))))))) : ((msg.tag === 4) ? ((oldScreenCentre_2 = msg.fields[0], (canvas = document.getElementById("Canvas"), (newScreenCentre = getVisibleScreenCentre(model), (requiredOffset = ((left_4 = oldScreenCentre_2, (right_4 = newScreenCentre, new XYPos(left_4.X - right_4.X, left_4.Y - right_4.Y)))), (toConsole(printf("KeepZoomCentred")), (canvas.scrollLeft = (canvas.scrollLeft + (requiredOffset.X * model.Zoom)), (canvas.scrollTop = (canvas.scrollTop + (requiredOffset.Y * model.Zoom)), [model, Cmd_none()])))))))) : ((msg.tag === 12) ? ((key = msg.fields[0], (containsKey = ((key_1, list_4) => exists((tupledArg_2) => {
        const key$0027 = tupledArg_2[0];
        const time = tupledArg_2[1];
        return equals(key$0027, key_1);
    }, list_4)), (newPressedKeys = cons([key.toLocaleUpperCase(), getTimeMs()], getActivePressedKeys(model)), (newCmd = ((containsKey("CONTROL", newPressedKeys) ? true : containsKey("META", newPressedKeys)) ? (containsKey("C", newPressedKeys) ? sheetCmd(new SheetT_Msg(2, [new SheetT_KeyboardMsg(1, [])])) : (containsKey("V", newPressedKeys) ? sheetCmd(new SheetT_Msg(2, [new SheetT_KeyboardMsg(2, [])])) : (containsKey("A", newPressedKeys) ? sheetCmd(new SheetT_Msg(2, [new SheetT_KeyboardMsg(5, [])])) : (containsKey("W", newPressedKeys) ? sheetCmd(new SheetT_Msg(2, [new SheetT_KeyboardMsg(6, [])])) : Cmd_none())))) : Cmd_none()), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, newPressedKeys, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), newCmd]))))) : ((msg.tag === 11) ? ((key_2 = msg.fields[0], (removeAllKeys = ((key_3, list_5) => filter((tupledArg_3) => {
        const k = tupledArg_3[0];
        const t = tupledArg_3[1];
        return !equals(k, key_3);
    }, list_5)), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, removeAllKeys(key_2.toLocaleUpperCase(), model.CurrentKeyPresses), model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()]))) : ((msg.tag === 13) ? ((canvas_1 = document.getElementById("Canvas"), (wholeApp = document.getElementById("WholeApp"), (rightSelection = document.getElementById("RightSelection"), (leftScreenEdge = canvas_1.scrollLeft, (rightScreenEdge = ((leftScreenEdge + wholeApp.clientWidth) - rightSelection.clientWidth), (upperScreenEdge = canvas_1.scrollTop, (lowerScreenEdge = (upperScreenEdge + canvas_1.clientHeight), (mPosX = (model.ScrollingLastMousePos.Pos.X * model.Zoom), (mPosY = (model.ScrollingLastMousePos.Pos.Y * model.Zoom), (mMovX = model.ScrollingLastMousePos.Move.X, (mMovY = model.ScrollingLastMousePos.Move.Y, (checkForAutomaticScrolling1D = ((edge_1, mPos, mMov) => {
        const scrollMargin = 100;
        const scrollSpeed = 10;
        const edgeDistance = Math.abs(edge_1 - mPos);
        if ((edgeDistance < scrollMargin) && (mMov >= -1E-07)) {
            return (scrollSpeed * (scrollMargin - edgeDistance)) / scrollMargin;
        }
        else {
            return 0;
        }
    }), (canvas_1.scrollLeft = (canvas_1.scrollLeft - checkForAutomaticScrolling1D(leftScreenEdge, mPosX, -mMovX)), (canvas_1.scrollLeft = (canvas_1.scrollLeft + checkForAutomaticScrolling1D(rightScreenEdge, mPosX, mMovX)), (canvas_1.scrollTop = (canvas_1.scrollTop - checkForAutomaticScrolling1D(upperScreenEdge, mPosY, -mMovY)), (canvas_1.scrollTop = (canvas_1.scrollTop + checkForAutomaticScrolling1D(lowerScreenEdge, mPosY, mMovY)), (xDiff = (canvas_1.scrollLeft - leftScreenEdge), (yDiff = (canvas_1.scrollTop - upperScreenEdge), ((xDiff !== 0) ? true : (yDiff !== 0)) ? ((newMPos = (new XYPos(model.LastMousePos.X + (xDiff / model.Zoom), model.LastMousePos.Y + (yDiff / model.Zoom))), (zero = (new XYPos(0, 0)), (defaultMsg = (new MouseT(newMPos, zero, zero, false, new MouseOp(2, []))), (patternInput_7 = ((matchValue_14 = model.Action, (matchValue_14.tag === 5) ? mMoveUpdate(new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, true, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), new MouseT(defaultMsg.Pos, defaultMsg.ScreenMovement, defaultMsg.ScreenPage, defaultMsg.ShiftKeyDown, new MouseOp(2, []))) : ((matchValue_14.tag === 3) ? mDragUpdate(new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, true, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), new MouseT(defaultMsg.Pos, defaultMsg.ScreenMovement, defaultMsg.ScreenPage, defaultMsg.ShiftKeyDown, new MouseOp(3, []))) : ((matchValue_14.tag === 8) ? mDragUpdate(new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, true, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), new MouseT(defaultMsg.Pos, defaultMsg.ScreenMovement, defaultMsg.ScreenPage, defaultMsg.ShiftKeyDown, new MouseOp(3, []))) : ((matchValue_14.tag === 9) ? mDragUpdate(new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, true, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), new MouseT(defaultMsg.Pos, defaultMsg.ScreenMovement, defaultMsg.ScreenPage, defaultMsg.ShiftKeyDown, new MouseOp(3, []))) : ((matchValue_14.tag === 0) ? mDragUpdate(new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, true, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), new MouseT(defaultMsg.Pos, defaultMsg.ScreenMovement, defaultMsg.ScreenPage, defaultMsg.ShiftKeyDown, new MouseOp(3, []))) : [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, true, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()])))))), (outputModel = patternInput_7[0], (outputCmd = patternInput_7[1], (notAutomaticScrolling = ((msg_1) => {
        let matchResult;
        if (msg_1.tag === 1) {
            if (msg_1.fields[0].tag === 13) {
                matchResult = 0;
            }
            else {
                matchResult = 1;
            }
        }
        else {
            matchResult = 1;
        }
        switch (matchResult) {
            case 0:
                return false;
            default:
                return true;
        }
    }), (filteredOutputCmd = Cmd_map((msg_2) => (notAutomaticScrolling(msg_2) ? msg_2 : (new Msg(1, [new SheetT_Msg(14, [])]))), outputCmd), (outputModel_1 = (new SheetT_Model(outputModel.Wire, outputModel.PopupViewFunc, outputModel.PopupDialogData, outputModel.BoundingBoxes, outputModel.LastValidBoundingBoxes, outputModel.SelectedLabel, outputModel.SelectedComponents, outputModel.SelectedWires, outputModel.NearbyComponents, outputModel.ErrorComponents, outputModel.DragToSelectBox, outputModel.ConnectPortsLine, outputModel.TargetPortId, outputModel.Action, outputModel.ShowGrid, outputModel.CursorType, outputModel.LastValidPos, outputModel.LastValidSymbol, outputModel.SnapSymbols, outputModel.SnapSegments, outputModel.CurrentKeyPresses, outputModel.Zoom, outputModel.CanvasSize, outputModel.TmpModel, outputModel.ScalingTmpModel, outputModel.UndoList, outputModel.RedoList, outputModel.AutomaticScrolling, new XYPos(canvas_1.scrollLeft, canvas_1.scrollTop), outputModel.LastMousePos, outputModel.ScalingBoxCentrePos, outputModel.InitMouseToScalingBoxCentre, outputModel.ScrollingLastMousePos, outputModel.LastMousePosForSnap, outputModel.MouseCounter, outputModel.CtrlKeyDown, outputModel.PrevWireSelection, outputModel.ScalingBox, outputModel.Compiling, outputModel.CompilationStatus, outputModel.CompilationProcess, outputModel.DebugState, outputModel.DebugData, outputModel.DebugMappings, outputModel.DebugIsConnected, outputModel.DebugDevice)), [outputModel_1, filteredOutputCmd])))))))))) : [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, false, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()]))))))))))))))))))) : ((msg.tag === 32) ? ((arrange = msg.fields[0], arrangeSymbols(arrange, model))) : ((msg.tag === 33) ? rotateSelectedLabelsClockwise(model) : ((msg.tag === 30) ? ((rotation_1 = msg.fields[0], (rotmodel = (new SheetT_Model((inputRecord_2 = model.Wire, new BusWireT_Model(rotateBlock(model.SelectedComponents, model.Wire.Symbol, rotation_1), inputRecord_2.Wires, inputRecord_2.CopiedWires, inputRecord_2.SelectedSegment, inputRecord_2.LastMousePos, inputRecord_2.ErrorWires, inputRecord_2.Notifications, inputRecord_2.Type, inputRecord_2.ArrowDisplay, inputRecord_2.SnapToNet)), model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model, model.ScalingTmpModel, appendUndoList(model.UndoList, model), model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice)), (newModel_1 = (new SheetT_Model(rotmodel.Wire, rotmodel.PopupViewFunc, rotmodel.PopupDialogData, getBoundingBoxes(rotmodel.Wire.Symbol), rotmodel.LastValidBoundingBoxes, rotmodel.SelectedLabel, rotmodel.SelectedComponents, rotmodel.SelectedWires, rotmodel.NearbyComponents, rotmodel.ErrorComponents, rotmodel.DragToSelectBox, rotmodel.ConnectPortsLine, rotmodel.TargetPortId, rotmodel.Action, rotmodel.ShowGrid, rotmodel.CursorType, rotmodel.LastValidPos, rotmodel.LastValidSymbol, rotmodel.SnapSymbols, rotmodel.SnapSegments, rotmodel.CurrentKeyPresses, rotmodel.Zoom, rotmodel.CanvasSize, rotmodel.TmpModel, rotmodel.ScalingTmpModel, rotmodel.UndoList, rotmodel.RedoList, rotmodel.AutomaticScrolling, rotmodel.ScreenScrollPos, rotmodel.LastMousePos, rotmodel.ScalingBoxCentrePos, rotmodel.InitMouseToScalingBoxCentre, rotmodel.ScrollingLastMousePos, rotmodel.LastMousePosForSnap, rotmodel.MouseCounter, rotmodel.CtrlKeyDown, rotmodel.PrevWireSelection, rotmodel.ScalingBox, rotmodel.Compiling, rotmodel.CompilationStatus, rotmodel.CompilationProcess, rotmodel.DebugState, rotmodel.DebugData, rotmodel.DebugMappings, rotmodel.DebugIsConnected, rotmodel.DebugDevice)), (errorComponents = filter((sId_1) => !notIntersectingComponents(newModel_1, FSharpMap__get_Item(newModel_1.BoundingBoxes, sId_1), sId_1), newModel_1.SelectedComponents), (toConsole(`ErrorComponents=${errorComponents}`), isEmpty(errorComponents) ? [new SheetT_Model(newModel_1.Wire, newModel_1.PopupViewFunc, newModel_1.PopupDialogData, newModel_1.BoundingBoxes, newModel_1.LastValidBoundingBoxes, newModel_1.SelectedLabel, newModel_1.SelectedComponents, newModel_1.SelectedWires, newModel_1.NearbyComponents, errorComponents, newModel_1.DragToSelectBox, newModel_1.ConnectPortsLine, newModel_1.TargetPortId, new SheetT_CurrentAction(11, []), newModel_1.ShowGrid, newModel_1.CursorType, newModel_1.LastValidPos, newModel_1.LastValidSymbol, newModel_1.SnapSymbols, newModel_1.SnapSegments, newModel_1.CurrentKeyPresses, newModel_1.Zoom, newModel_1.CanvasSize, newModel_1.TmpModel, newModel_1.ScalingTmpModel, newModel_1.UndoList, newModel_1.RedoList, newModel_1.AutomaticScrolling, newModel_1.ScreenScrollPos, newModel_1.LastMousePos, newModel_1.ScalingBoxCentrePos, newModel_1.InitMouseToScalingBoxCentre, newModel_1.ScrollingLastMousePos, newModel_1.LastMousePosForSnap, newModel_1.MouseCounter, newModel_1.CtrlKeyDown, newModel_1.PrevWireSelection, newModel_1.ScalingBox, newModel_1.Compiling, newModel_1.CompilationStatus, newModel_1.CompilationProcess, newModel_1.DebugState, newModel_1.DebugData, newModel_1.DebugMappings, newModel_1.DebugIsConnected, newModel_1.DebugDevice), Cmd_batch(ofArray([symbolCmd(new SymbolT_Msg(16, [errorComponents, newModel_1.SelectedComponents, false])), wireCmd(new BusWireT_Msg(19, [newModel_1.SelectedComponents])), sheetCmd(new SheetT_Msg(6, []))]))] : [new SheetT_Model(newModel_1.Wire, newModel_1.PopupViewFunc, newModel_1.PopupDialogData, newModel_1.BoundingBoxes, newModel_1.LastValidBoundingBoxes, newModel_1.SelectedLabel, newModel_1.SelectedComponents, newModel_1.SelectedWires, newModel_1.NearbyComponents, errorComponents, newModel_1.DragToSelectBox, newModel_1.ConnectPortsLine, newModel_1.TargetPortId, new SheetT_CurrentAction(5, []), newModel_1.ShowGrid, newModel_1.CursorType, newModel_1.LastValidPos, newModel_1.LastValidSymbol, newModel_1.SnapSymbols, newModel_1.SnapSegments, newModel_1.CurrentKeyPresses, newModel_1.Zoom, newModel_1.CanvasSize, newModel_1.TmpModel, newModel_1.ScalingTmpModel, newModel_1.UndoList, newModel_1.RedoList, newModel_1.AutomaticScrolling, newModel_1.ScreenScrollPos, newModel_1.LastMousePos, newModel_1.ScalingBoxCentrePos, newModel_1.InitMouseToScalingBoxCentre, newModel_1.ScrollingLastMousePos, newModel_1.LastMousePosForSnap, newModel_1.MouseCounter, newModel_1.CtrlKeyDown, newModel_1.PrevWireSelection, newModel_1.ScalingBox, newModel_1.Compiling, newModel_1.CompilationStatus, newModel_1.CompilationProcess, newModel_1.DebugState, newModel_1.DebugData, newModel_1.DebugMappings, newModel_1.DebugIsConnected, newModel_1.DebugDevice), Cmd_batch(ofArray([symbolCmd(new SymbolT_Msg(16, [errorComponents, newModel_1.SelectedComponents, false])), wireCmd(new BusWireT_Msg(19, [newModel_1.SelectedComponents])), sheetCmd(new SheetT_Msg(6, []))]))])))))) : ((msg.tag === 31) ? ((orientation = msg.fields[0], (flipmodel = (new SheetT_Model((inputRecord_3 = model.Wire, new BusWireT_Model(flipBlock(model.SelectedComponents, model.Wire.Symbol, orientation), inputRecord_3.Wires, inputRecord_3.CopiedWires, inputRecord_3.SelectedSegment, inputRecord_3.LastMousePos, inputRecord_3.ErrorWires, inputRecord_3.Notifications, inputRecord_3.Type, inputRecord_3.ArrowDisplay, inputRecord_3.SnapToNet)), model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model, model.ScalingTmpModel, appendUndoList(model.UndoList, model), model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice)), (newModel_2 = (new SheetT_Model(flipmodel.Wire, flipmodel.PopupViewFunc, flipmodel.PopupDialogData, getBoundingBoxes(flipmodel.Wire.Symbol), flipmodel.LastValidBoundingBoxes, flipmodel.SelectedLabel, flipmodel.SelectedComponents, flipmodel.SelectedWires, flipmodel.NearbyComponents, flipmodel.ErrorComponents, flipmodel.DragToSelectBox, flipmodel.ConnectPortsLine, flipmodel.TargetPortId, flipmodel.Action, flipmodel.ShowGrid, flipmodel.CursorType, flipmodel.LastValidPos, flipmodel.LastValidSymbol, flipmodel.SnapSymbols, flipmodel.SnapSegments, flipmodel.CurrentKeyPresses, flipmodel.Zoom, flipmodel.CanvasSize, flipmodel.TmpModel, flipmodel.ScalingTmpModel, flipmodel.UndoList, flipmodel.RedoList, flipmodel.AutomaticScrolling, flipmodel.ScreenScrollPos, flipmodel.LastMousePos, flipmodel.ScalingBoxCentrePos, flipmodel.InitMouseToScalingBoxCentre, flipmodel.ScrollingLastMousePos, flipmodel.LastMousePosForSnap, flipmodel.MouseCounter, flipmodel.CtrlKeyDown, flipmodel.PrevWireSelection, flipmodel.ScalingBox, flipmodel.Compiling, flipmodel.CompilationStatus, flipmodel.CompilationProcess, flipmodel.DebugState, flipmodel.DebugData, flipmodel.DebugMappings, flipmodel.DebugIsConnected, flipmodel.DebugDevice)), (errorComponents_1 = filter((sId_2) => !notIntersectingComponents(newModel_2, FSharpMap__get_Item(newModel_2.BoundingBoxes, sId_2), sId_2), newModel_2.SelectedComponents), (toConsole(`ErrorComponents=${errorComponents_1}`), (nextAction = (isEmpty(errorComponents_1) ? newModel_2.Action : (new SheetT_CurrentAction(5, []))), [new SheetT_Model(newModel_2.Wire, newModel_2.PopupViewFunc, newModel_2.PopupDialogData, newModel_2.BoundingBoxes, newModel_2.LastValidBoundingBoxes, newModel_2.SelectedLabel, newModel_2.SelectedComponents, newModel_2.SelectedWires, newModel_2.NearbyComponents, errorComponents_1, newModel_2.DragToSelectBox, newModel_2.ConnectPortsLine, newModel_2.TargetPortId, nextAction, newModel_2.ShowGrid, newModel_2.CursorType, newModel_2.LastValidPos, newModel_2.LastValidSymbol, newModel_2.SnapSymbols, newModel_2.SnapSegments, newModel_2.CurrentKeyPresses, newModel_2.Zoom, newModel_2.CanvasSize, newModel_2.TmpModel, newModel_2.ScalingTmpModel, newModel_2.UndoList, newModel_2.RedoList, newModel_2.AutomaticScrolling, newModel_2.ScreenScrollPos, newModel_2.LastMousePos, newModel_2.ScalingBoxCentrePos, newModel_2.InitMouseToScalingBoxCentre, newModel_2.ScrollingLastMousePos, newModel_2.LastMousePosForSnap, newModel_2.MouseCounter, newModel_2.CtrlKeyDown, newModel_2.PrevWireSelection, newModel_2.ScalingBox, newModel_2.Compiling, newModel_2.CompilationStatus, newModel_2.CompilationProcess, newModel_2.DebugState, newModel_2.DebugData, newModel_2.DebugMappings, newModel_2.DebugIsConnected, newModel_2.DebugDevice), Cmd_batch(ofArray([symbolCmd(new SymbolT_Msg(16, [errorComponents_1, newModel_2.SelectedComponents, false])), wireCmd(new BusWireT_Msg(19, [newModel_2.SelectedComponents])), sheetCmd(new SheetT_Msg(6, []))]))]))))))) : ((msg.tag === 37) ? [model, symbolCmd(new SymbolT_Msg(40, []))] : ((msg.tag === 34) ? ((msg.fields[0].tag === 1) ? ((wires_2 = map_1((tuple_3) => tuple_3[0], toList_1(model.Wire.Wires)), [model, Cmd_batch(ofArray([wireCmd(new BusWireT_Msg(15, [new BusWireT_WireType(0, [])])), wireCmd(new BusWireT_Msg(14, [false, wires_2]))]))])) : ((msg.fields[0].tag === 2) ? ((wires_3 = map_1((tuple_4) => tuple_4[0], toList_1(model.Wire.Wires)), [model, Cmd_batch(ofArray([wireCmd(new BusWireT_Msg(15, [new BusWireT_WireType(1, [])])), wireCmd(new BusWireT_Msg(14, [false, wires_3]))]))])) : ((wires_1 = map_1((tuple_2) => tuple_2[0], toList_1(model.Wire.Wires)), [model, Cmd_batch(ofArray([wireCmd(new BusWireT_Msg(15, [new BusWireT_WireType(2, [])])), wireCmd(new BusWireT_Msg(14, [false, wires_1]))]))])))) : ((msg.tag === 19) ? ((compType = msg.fields[1], (lbl = msg.fields[2], (ldcs_1 = msg.fields[0], ($007CIsGate$007CNoGate$007C(compType).tag === 1) ? [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, new SheetT_CurrentAction(13, [ldcs_1, compType, lbl]), model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model, model.ScalingTmpModel, appendUndoList(model.UndoList, model), model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()] : [(UndoList_5 = appendUndoList(model.UndoList, model), new SheetT_Model((inputRecord_4 = model.Wire, new BusWireT_Model((inputRecord_5 = model.Wire.Symbol, new SymbolT_Model(inputRecord_5.Symbols, inputRecord_5.CopiedSymbols, inputRecord_5.Ports, inputRecord_5.InputPortsConnected, inputRecord_5.OutputPortsConnected, inputRecord_5.Theme, (children = ["You can change the number of inputs", react.createElement("br", {}), "in the component properties menu"], react.createElement("div", {}, ...children)))), inputRecord_4.Wires, inputRecord_4.CopiedWires, inputRecord_4.SelectedSegment, inputRecord_4.LastMousePos, inputRecord_4.ErrorWires, inputRecord_4.Notifications, inputRecord_4.Type, inputRecord_4.ArrowDisplay, inputRecord_4.SnapToNet)), model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, new SheetT_CurrentAction(13, [ldcs_1, compType, lbl]), model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model, model.ScalingTmpModel, UndoList_5, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice)), Cmd_none()])))) : ((msg.tag === 20) ? [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, void 0, model.ScalingTmpModel, empty(), empty(), model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()] : ((msg.tag === 21) ? [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, empty_1({
        Compare: compare,
    }), empty_1({
        Compare: compare,
    }), model.SelectedLabel, empty(), empty(), empty(), empty(), new BoundingBox(new XYPos(0, 0), 0, 0), [new XYPos(0, 0), new XYPos(0, 0)], "", new SheetT_CurrentAction(11, []), model.ShowGrid, model.CursorType, new XYPos(0, 0), model.LastValidSymbol, emptySnap, emptySnap, empty(), 1, model.CanvasSize, void 0, void 0, empty(), empty(), false, model.ScreenScrollPos, new XYPos(0, 0), model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, new SheetT_XYPosMov(new XYPos(0, 0), new XYPos(0, 0)), new XYPos(0, 0), 0, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()] : ((msg.tag === 22) ? ((connIds = msg.fields[0], (on = msg.fields[1], (oldWires = model.SelectedWires, (newWires = (on ? append(oldWires, connIds) : filter((conId) => !contains(conId, connIds, {
        Equals: equals,
        GetHashCode: safeHash,
    }), oldWires)), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, newWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), wireCmd(new BusWireT_Msg(6, [newWires]))]))))) : ((msg.tag === 23) ? ((colour = msg.fields[2], (compIds = msg.fields[0], (connIds_1 = msg.fields[1], [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, compIds, connIds_1, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([symbolCmd(new SymbolT_Msg(15, [compIds, colour])), wireCmd(new BusWireT_Msg(11, [connIds_1, colour]))]))])))) : ((msg.tag === 26) ? [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, empty(), empty(), model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([symbolCmd(new SymbolT_Msg(11, [empty()])), wireCmd(new BusWireT_Msg(6, [empty()]))]))] : ((msg.tag === 28) ? ((cIds = msg.fields[0], (newWires_1 = (exists((cId) => contains(cId, model.PrevWireSelection, {
        Equals: equals,
        GetHashCode: safeHash,
    }), cIds) ? filter((cId_1) => !contains(cId_1, cIds, {
        Equals: equals,
        GetHashCode: safeHash,
    }), model.PrevWireSelection) : append(cIds, model.PrevWireSelection)), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, newWires_1, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_batch(ofArray([sheetCmd(new SheetT_Msg(23, [empty(), newWires_1, new HighLightColor(11, [])])), wireCmd(new BusWireT_Msg(6, [newWires_1]))]))]))) : ((msg.tag === 29) ? ((isOn = msg.fields[0], isOn ? [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, new SheetT_CursorType(3, []), model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()] : [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, new SheetT_CursorType(0, []), model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()])) : ((msg.tag === 38) ? ((name = msg.fields[1], (path = msg.fields[0], (profile = msg.fields[2], (toConsole(printf("starting compiling %s :: %s"))(path)(name), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, true, new SheetT_CompileStatus(new SheetT_CompilationStage(1, [0]), new SheetT_CompilationStage(3, []), new SheetT_CompilationStage(3, []), new SheetT_CompilationStage(3, [])), model.CompilationProcess, (profile.tag === 0) ? (new SheetT_DebugState(0, [])) : (new SheetT_DebugState(1, [])), model.DebugData, model.DebugMappings, false, model.DebugDevice), sheetCmd(new SheetT_Msg(39, [new SheetT_CompilationStageLabel(0, []), path, name, profile]))]))))) : ((msg.tag === 39) ? ((name_1 = msg.fields[2], (path_1 = msg.fields[1], (profile_1 = msg.fields[3], (stage = msg.fields[0], (toConsole(printf("are we compiling? %A"))(model.Compiling), ((arg_7 = map_2((c) => c.pid, model.CompilationProcess), toConsole(printf("do we have process? %A"))(arg_7)), !model.Compiling ? [model, Cmd_none()] : ((cwd = (process.cwd()), (include_path = ((debugLevel() !== 0) ? (cwd + "/static/hdl") : (cwd + "/resources/static/hdl")), (toConsole(printf("include_path: %s"))(include_path), (patternInput_8 = ((matchValue_16 = model.DebugDevice, (matchValue_16 != null) ? ((matchValue_16 === "IceStick") ? ((profile_1.tag === 1) ? [`${include_path}/icestick_debug.pcf`, "--hx1k", "tq144"] : [`${include_path}/icestick.pcf`, "--hx1k", "tq144"]) : ((matchValue_16 === "IssieStick-v0.1") ? ((profile_1.tag === 1) ? [`${include_path}/issiestick-0.1_debug.pcf`, "--hx4k", "tq144"] : [`${include_path}/issiestick-0.1.pcf`, "--hx4k", "tq144"]) : ((matchValue_16 === "IssieStick-v1.0") ? ((profile_1.tag === 1) ? [`${include_path}/issiestick-1.0_debug.pcf`, "--hx8k", "bg121"] : [`${include_path}/issiestick-1.0.pcf`, "--hx8k", "bg121"]) : toFail(printf("Undefined device used in compilation!"))))) : toFail(printf("Undefined device used in compilation!")))), (pcf = patternInput_8[0], (deviceType = patternInput_8[1], (devicePackage = patternInput_8[2], (patternInput_9 = ((stage.tag === 1) ? ["nextpnr-ice40", ofArray(["--package", `${devicePackage}`, `${deviceType}`, "--pcf", `${pcf}`, "--json", `${path_1}/build/${name_1}.json`, "--asc", `${path_1}/build/${name_1}.asc`])] : ((stage.tag === 2) ? ["icepack", ofArray([`${path_1}/build/${name_1}.asc`, `${path_1}/build/${name_1}.bin`])] : ((stage.tag === 3) ? ["iceprog", singleton(`${path_1}/build/${name_1}.bin`)] : ["yosys", ofArray(["-p", `read_verilog -I${include_path} ${path_1}/${name_1}.v; synth_ice40 -flatten -json ${path_1}/build/${name_1}.json`])]))), (prog = patternInput_9[0], (args = patternInput_9[1], (options = ((o = {
        shell: false,
    }, Object.assign({}, o))), (child = child_process.spawn(prog, Array.from(args), some(options)), (startComp = ((dispatch_1) => {
        const dispatchS = (msg_3) => {
            dispatch_1(new Msg(1, [msg_3]));
        };
        toConsole(printf("starting stage %A"))(stage);
        startImmediate(singleton_1.Delay(() => {
            const exit_code = new FSharpRef(0);
            return singleton_1.TryFinally(singleton_1.Delay(() => {
                const keepGoing = new FSharpRef(true);
                child.stdout.on("data", (_arg_1) => {
                });
                child.stderr.on("data", (e) => {
                    toConsole(printf("Error: %s"))(e);
                });
                child.on("exit", (code) => {
                    keepGoing.contents = false;
                    exit_code.contents = (code | 0);
                });
                return singleton_1.While(() => keepGoing.contents, singleton_1.Delay(() => singleton_1.Bind(sleep(1000), () => {
                    const arg_12 = keepGoing.contents;
                    toConsole(printf("state of child: %A"))(arg_12);
                    dispatchS(new SheetT_Msg(41, [child.pid]));
                    return singleton_1.Zero();
                })));
            }), () => {
                const arg_13 = exit_code.contents | 0;
                toConsole(printf("Child finished with exit code: %i"))(arg_13);
                if (exit_code.contents === 0) {
                    dispatchS(new SheetT_Msg(42, []));
                    switch (stage.tag) {
                        case 1: {
                            dispatchS(new SheetT_Msg(39, [new SheetT_CompilationStageLabel(2, []), path_1, name_1, profile_1]));
                            break;
                        }
                        case 2: {
                            dispatchS(new SheetT_Msg(39, [new SheetT_CompilationStageLabel(3, []), path_1, name_1, profile_1]));
                            break;
                        }
                        case 3: {
                            if (equals(profile_1, new CompilationProfile(1, []))) {
                                dispatchS(new SheetT_Msg(47, []));
                            }
                            break;
                        }
                        default:
                            dispatchS(new SheetT_Msg(39, [new SheetT_CompilationStageLabel(1, []), path_1, name_1, profile_1]));
                    }
                }
                else {
                    dispatchS(new SheetT_Msg(40, []));
                }
            });
        }));
    }), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, child, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_ofSub(startComp)]))))))))))))))))))))) : ((msg.tag === 40) ? (((matchValue_18 = model.CompilationProcess, (matchValue_18 != null) ? ((child_1 = matchValue_18, child_1.kill())) : void 0), (failIfInProgress = ((stage_1) => {
        if (stage_1.tag === 1) {
            const t_1 = stage_1.fields[0] | 0;
            return new SheetT_CompilationStage(2, []);
        }
        else {
            const s_2 = stage_1;
            return s_2;
        }
    }), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, false, new SheetT_CompileStatus(failIfInProgress(model.CompilationStatus.Synthesis), failIfInProgress(model.CompilationStatus.PlaceAndRoute), failIfInProgress(model.CompilationStatus.Generate), failIfInProgress(model.CompilationStatus.Upload)), void 0, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()]))) : ((msg.tag === 41) ? ((pid = msg.fields[0], (correctPid = defaultArg(map_2((child_2) => (child_2.pid === pid), model.CompilationProcess), false), (tick = ((stage_2) => {
        let t_2;
        let matchResult_1, t_3, s_3;
        if (stage_2.tag === 1) {
            if ((t_2 = (stage_2.fields[0] | 0), correctPid)) {
                matchResult_1 = 0;
                t_3 = stage_2.fields[0];
            }
            else {
                matchResult_1 = 1;
                s_3 = stage_2;
            }
        }
        else {
            matchResult_1 = 1;
            s_3 = stage_2;
        }
        switch (matchResult_1) {
            case 0:
                return new SheetT_CompilationStage(1, [t_3 + 1]);
            default:
                return s_3;
        }
    }), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, new SheetT_CompileStatus(tick(model.CompilationStatus.Synthesis), tick(model.CompilationStatus.PlaceAndRoute), tick(model.CompilationStatus.Generate), tick(model.CompilationStatus.Upload)), model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()])))) : ((msg.tag === 42) ? ((model_6 = (!model.Compiling ? model : ((finishOrStart = ((cur, prev) => {
        let matchResult_2, t_4, cur_1;
        if (cur.tag === 1) {
            matchResult_2 = 0;
            t_4 = cur.fields[0];
        }
        else if (prev != null) {
            if (prev.tag === 1) {
                matchResult_2 = 1;
            }
            else {
                matchResult_2 = 2;
                cur_1 = cur;
            }
        }
        else {
            matchResult_2 = 2;
            cur_1 = cur;
        }
        switch (matchResult_2) {
            case 0:
                return new SheetT_CompilationStage(0, [t_4]);
            case 1:
                return new SheetT_CompilationStage(1, [0]);
            default:
                return cur_1;
        }
    }), (synthesis = model.CompilationStatus.Synthesis, (placeAndRoute = model.CompilationStatus.PlaceAndRoute, (generate = model.CompilationStatus.Generate, (upload = model.CompilationStatus.Upload, (isCompiling = ((upload.tag === 1) ? false : model.Compiling), new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, isCompiling, new SheetT_CompileStatus(finishOrStart(synthesis, void 0), finishOrStart(placeAndRoute, synthesis), finishOrStart(generate, placeAndRoute), finishOrStart(upload, generate)), model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice))))))))), [model_6, Cmd_none()])) : ((msg.tag === 43) ? ((remainder = ((model.DebugMappings.length % 8) | 0), (viewerNo = (((remainder === 0) ? ~~(model.DebugMappings.length / 8) : (~~(model.DebugMappings.length / 8) + 1)) | 0), [model, sheetCmd(new SheetT_Msg(44, [viewerNo]))]))) : ((msg.tag === 44) ? ((n_2 = (msg.fields[0] | 0), (readSingleStep = ((viewers, dispatch_2) => {
        startImmediate(singleton_1.Delay(() => {
            const exit_code_1 = new FSharpRef(0);
            return singleton_1.TryFinally(singleton_1.Delay(() => {
                const keepGoing_1 = new FSharpRef(true);
                const r = stepAndReadAllViewers(viewers);
                r.then((v) => {
                    iterateIndexed((i, reading) => {
                        let copyOfStruct, copyOfStruct_1;
                        dispatch_2(new Msg(1, [new SheetT_Msg(46, [hextoInt(((copyOfStruct = reading[0], copyOfStruct)) + ((copyOfStruct_1 = reading[1], copyOfStruct_1))), i])]));
                    }, v);
                });
                keepGoing_1.contents = false;
                return singleton_1.Zero();
            }), () => {
            });
        }));
    }), [model, Cmd_ofSub(curry2(readSingleStep)(n_2))]))) : ((msg.tag === 45) ? ((n_3 = (msg.fields[0] | 0), (readSingleStep_1 = ((viewers_1, dispatch_3) => {
        startImmediate(singleton_1.Delay(() => {
            const exit_code_2 = new FSharpRef(0);
            return singleton_1.TryFinally(singleton_1.Delay(() => {
                const keepGoing_2 = new FSharpRef(true);
                const r_1 = readAllViewers(viewers_1);
                r_1.then((v_1) => {
                    iterateIndexed((i_1, reading_1) => {
                        let copyOfStruct_2, copyOfStruct_3;
                        dispatch_3(new Msg(1, [new SheetT_Msg(46, [hextoInt(((copyOfStruct_2 = reading_1[0], copyOfStruct_2)) + ((copyOfStruct_3 = reading_1[1], copyOfStruct_3))), i_1])]));
                    }, v_1);
                });
                keepGoing_2.contents = false;
                return singleton_1.Zero();
            }), () => {
            });
        }));
    }), [model, Cmd_ofSub(curry2(readSingleStep_1)(n_3))]))) : ((msg.tag === 47) ? ((remainder_1 = ((model.DebugMappings.length % 8) | 0), (viewerNo_1 = (((remainder_1 === 0) ? ~~(model.DebugMappings.length / 8) : (~~(model.DebugMappings.length / 8) + 1)) | 0), (connectAndRead = ((viewers_2, dispatch_4) => {
        startImmediate(singleton_1.Delay(() => {
            const exit_code_3 = new FSharpRef(0);
            return singleton_1.TryFinally(singleton_1.Delay(() => {
                const keepGoing_3 = new FSharpRef(true);
                const c_1 = simpleConnect(undefined);
                c_1.then(() => dispatch_4(new Msg(1, [new SheetT_Msg(45, [viewers_2])])));
                keepGoing_3.contents = false;
                return singleton_1.Zero();
            }), () => {
            });
        }));
    }), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, true, model.DebugDevice), Cmd_ofSub(curry2(connectAndRead)(viewerNo_1))])))) : ((msg.tag === 48) ? ((toConsole(printf("Closing device")), (disconnect(), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, false, model.DebugDevice), Cmd_none()]))) : ((msg.tag === 46) ? ((data = (msg.fields[0] | 0), (whichViewer = (msg.fields[1] | 0), (part = (whichViewer | 0), (bits = join(",", map_1(toString, map_1((i_2) => (~~(data / Math.pow(2, i_2)) % 2), reverse(toList_2(rangeDouble(0, 1, 7)))))), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, insertAt(part, data, removeAt(part, model.DebugData)), model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()]))))) : ((msg.tag === 49) ? ((mappings = msg.fields[0], [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, mappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()])) : ((msg.tag === 50) ? ((continuedOp(), (toConsole(printf("Continued execution")), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, new SheetT_DebugState(2, []), model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()]))) : ((msg.tag === 51) ? ((pauseOp(), (toConsole(printf("Continued execution Stopped")), (remainder_2 = ((model.DebugMappings.length % 8) | 0), (viewerNo_2 = (((remainder_2 === 0) ? ~~(model.DebugMappings.length / 8) : (~~(model.DebugMappings.length / 8) + 1)) | 0), [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, new SheetT_DebugState(1, []), model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), sheetCmd(new SheetT_Msg(44, [viewerNo_2]))]))))) : ((msg.tag === 52) ? ((device = msg.fields[0], [new SheetT_Model(model.Wire, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, device), Cmd_none()])) : ((msg.tag === 56) ? [model, wireCmd(new BusWireT_Msg(21, []))] : ((msg.tag === 58) ? ((sheetMsgs = msg.fields[0], [model, Cmd_batch(map_1((arg_16) => Cmd_OfFunc_result(new Msg(1, [arg_16])), sheetMsgs))])) : ((msg.tag === 1) ? ((wModel_1 = msg.fields[0], [new SheetT_Model(wModel_1, model.PopupViewFunc, model.PopupDialogData, model.BoundingBoxes, model.LastValidBoundingBoxes, model.SelectedLabel, model.SelectedComponents, model.SelectedWires, model.NearbyComponents, model.ErrorComponents, model.DragToSelectBox, model.ConnectPortsLine, model.TargetPortId, model.Action, model.ShowGrid, model.CursorType, model.LastValidPos, model.LastValidSymbol, model.SnapSymbols, model.SnapSegments, model.CurrentKeyPresses, model.Zoom, model.CanvasSize, model.TmpModel, model.ScalingTmpModel, model.UndoList, model.RedoList, model.AutomaticScrolling, model.ScreenScrollPos, model.LastMousePos, model.ScalingBoxCentrePos, model.InitMouseToScalingBoxCentre, model.ScrollingLastMousePos, model.LastMousePosForSnap, model.MouseCounter, model.CtrlKeyDown, model.PrevWireSelection, model.ScalingBox, model.Compiling, model.CompilationStatus, model.CompilationProcess, model.DebugState, model.DebugData, model.DebugMappings, model.DebugIsConnected, model.DebugDevice), Cmd_none()])) : ((msg.tag === 27) ? [model, Cmd_none()] : ((msg.tag === 14) ? [model, Cmd_none()] : [model, Cmd_none()])))))))))))))))))))))))))))))))))))))))))))))))));
    const model_7 = tupledArg_4[0];
    const cmd_3 = tupledArg_4[1];
    return [new Model(issieModel.UserData, issieModel.WaveSim, issieModel.WaveSimSheet, issieModel.UISheetTrail, issieModel.Spinner, model_7, issieModel.IsLoading, issieModel.LastChangeCheckTime, issieModel.LastSimulatedCanvasState, issieModel.LastDetailedSavedState, issieModel.CurrentSelected, issieModel.LastSelectedIds, issieModel.LastUsedDialogWidth, issieModel.SelectedComponent, issieModel.CurrentStepSimulationStep, issieModel.CurrentTruthTable, issieModel.TTConfig, issieModel.RightPaneTabVisible, issieModel.SimSubTabVisible, issieModel.Hilighted, issieModel.Clipboard, issieModel.LastCreatedComponent, issieModel.SavedSheetIsOutOfDate, issieModel.CurrentProj, issieModel.PopupViewFunc, issieModel.SpinnerPayload, issieModel.PopupDialogData, issieModel.Notifications, issieModel.TopMenuOpenState, issieModel.DividerDragMode, issieModel.WaveSimViewerWidth, issieModel.ConnsOfSelectedWavesAreHighlighted, issieModel.Pending, issieModel.UIState, issieModel.BuildVisible, issieModel.DrawBlockTestState), cmd_3];
}

/**
 * Init function
 */
export function init() {
    const patternInput = init_1();
    const wireModel = patternInput[0];
    const cmds = patternInput[1];
    const boundingBoxes = getBoundingBoxes(wireModel.Symbol);
    return [new SheetT_Model(wireModel, void 0, new SheetT_PopupDialogData(void 0, void 0, void 0), boundingBoxes, boundingBoxes, void 0, empty(), empty(), empty(), empty(), new BoundingBox(new XYPos(0, 0), 0, 0), [new XYPos(0, 0), new XYPos(0, 0)], "", new SheetT_CurrentAction(11, []), false, new SheetT_CursorType(0, []), new XYPos(0, 0), void 0, emptySnap, emptySnap, empty(), 1, Constants_defaultCanvasSize, void 0, void 0, empty(), empty(), false, new XYPos(0, 0), new XYPos(0, 0), new XYPos(0, 0), new XYPos(0, 0), new SheetT_XYPosMov(new XYPos(0, 0), new XYPos(0, 0)), new XYPos(0, 0), 0, false, empty(), void 0, false, new SheetT_CompileStatus(new SheetT_CompilationStage(3, []), new SheetT_CompilationStage(3, []), new SheetT_CompilationStage(3, []), new SheetT_CompilationStage(3, [])), void 0, new SheetT_DebugState(0, []), map_1((i) => 59, toList_2(rangeDouble(1, 1, 256))), [], false, void 0), Cmd_none()];
}

//# sourceMappingURL=SheetUpdate.fs.js.map
